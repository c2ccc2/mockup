import{_ as ne,C as re,e as ce,w as pe,r as b,D as x,K as ue,L as me,f as v,c as w,n as d,h as t,i as l,p,H as q,I as H,l as a,F as S,v as fe,x as ge,o as C,j as _e,k as ve,M as he,B as E}from"./index-DzSnaHIP.js";import{l as ye,d as Ie,a as be,e as ke,u as De,b as Fe,c as je}from"./space-CRp7hExf.js";const M=$=>(fe("data-v-83ab6ebd"),$=$(),ge(),$),Ce={class:"main"},$e={class:"header"},we=M(()=>d("span",{class:"title"},"原型管理",-1)),Ue={class:"content"},Ve={class:"card-header"},xe={class:"button-group"},Re={class:"version-header"},Se={class:"version-actions"},Ee={class:"version-description"},Me={key:0,class:"visit-link"},Pe={class:"dialog-footer"},Le={class:"dialog-footer"},ze={class:"upload-dialog"},Ne=M(()=>d("div",{class:"upload-text"},[d("p",{class:"main-text"},"拖拽文件到此区域 或"),d("em",{class:"click-text"},"点击选择文件")],-1)),Be=M(()=>d("div",{class:"upload-tip"},[d("span",{style:{color:"#67C23A"}},"支持扩展名：.zip "),d("br"),d("span",{style:{color:"#909399"}},"（单个文件建议不超过10MB）")],-1)),qe={class:"dialog-footer"},He={class:"dialog-footer"},Te=re({name:"prototype"}),Ae=Object.assign(Te,{props:{projectId:{type:[String,Number],required:!0}},setup($){const{proxy:r}=ce(),m=$;pe(()=>m.projectId,e=>{if(console.log("项目ID变化:",e),!(e==="0"||e===0)){if(e===""){console.log("knowLedge界面，项目ID是0 ，开始返回:");return}h(e)}});const P=b({pageIndex:1,pageSize:10,totalCount:0}),k=b([]),T=x({UploadDescription:[{required:!0,message:"版本描述不能为空",trigger:"blur"}]}),D=b(!1),F=b(!1),U=b(null),f=x({name:"",description:""}),L={uploadDescription:[{required:!0,message:"原型名称不能为空",trigger:"blur"},{max:50,message:"长度不能超过50个字符",trigger:"blur"}]},n=x({open:!1,title:"上传原型文件,zip格式",isUploading:!1,data:{UploadDescription:"",ProjectFileId:""},headers:{Authorization:"Bearer "+ue()},url:"/prod-api".replace(/\/?$/,"")+"/projectManager/projectfile/AddFileToProjectFile"}),j=b(!1),y=x({historyId:"",UploadDescription:""}),A={UploadDescription:[{required:!0,message:"文件描述不能为空",trigger:"blur"}]},z=b(null);me(()=>{h(m.projectId)});function h(e){if(!e)return;const o=String(e);console.log("加载数据:",e);let i={projectId:o,pageModel:P.value};ye(i).then(I=>{console.log("res",I),P.totalCount=I.total,k.value=I.rows,k.value.length>0&&Promise.all(k.value.map(async c=>{try{const g=await Ie({projectFileId:c.projectFileId,pageModel:{pageIndex:1,pageSize:10,totalCount:0}});c.versions=g.rows.map(u=>({version:`v${u.version}`,description:u.uploadDescription,time:u.updateTime,historyId:u.historyId,filePath:u.filePath,fileName:u.fileName}))}catch(g){console.error(`获取文件列表失败(ID:${c.projectFileId}):`,g),c.versions=[]}})),console.log("完整数据:",k.value)})}function O(){console.log("添加原型"),f.uploadDescription="",D.value=!0}async function K(){try{await U.value.validate();const e=await be({projectId:m.projectId,...f});e.code===200?(r.$modal.msgSuccess("新增成功"),D.value=!1,h(m.projectId)):r.$modal.msgError("添加失败："+e.message)}catch(e){console.error("表单验证失败:",e)}}function G(e){const o=k.value.find(i=>i.projectFileId===e);if(!o){r.$modal.msgError("未找到原型数据");return}Object.assign(f,{projectFileId:o.projectFileId,uploadDescription:o.uploadDescription}),F.value=!0}async function J(){try{await U.value.validate();const e=await ke({projectId:m.projectId,...f});e.code===200?(r.$modal.msgSuccess("修改成功"),F.value=!1,h(m.projectId)):r.$modal.msgError("修改失败："+e.message)}catch(e){console.error("表单验证失败:",e)}}async function Q(e){try{await r.$modal.confirm("确定删除该原型？","警告",{type:"warning"})&&(await je(e.toString())).code===200&&(r.$modal.msgSuccess("删除成功"),h(m.projectId))}catch{console.log("取消删除")}}function W(e){n.data.ProjectFileId=e,n.open=!0}const X=(e,o,i)=>{n.isUploading=!0},Y=(e,o,i)=>{n.open=!1,n.isUploading=!1,r.$refs.uploadRef.handleRemove(o),r.$alert("<div style='overflow: auto;overflow-x: hidden;max-height: 70vh;padding: 10px 20px 0;'>"+e.msg+"</div>","上传结果",{dangerouslyUseHTMLString:!0}),e.code===200?(r.$modal.msgSuccess("上传成功"),h(m.projectId)):r.$modal.msgError("上传失败："+e.message)};function Z(){console.log("上传地址:",n.url),r.$refs.uploadFormRef.validate(e=>{if(e)console.log("上传地址:",n.url),r.$refs.uploadRef.submit();else return r.$modal.msgError("请填写版本描述"),!1})}function ee(e){console.log("projectFileId:",e);const i="/prod-api".replace(/\/?$/,"")+"/upload/projectunzip/"+e+"/start.html#&g=1";window.open(i,"_blank")}function oe(e,o){y.historyId=o.historyId,y.UploadDescription=o.description,j.value=!0}async function te(){try{await z.value.validate();const e=await De({historyId:y.historyId,uploadDescription:y.UploadDescription});e.code===200?(r.$modal.msgSuccess("修改成功"),j.value=!1,h(m.projectId)):r.$modal.msgError("修改失败："+e.message)}catch(e){console.error("表单验证失败:",e)}}function le(e,o){console.log("删除:",o),r.$modal.confirm("是否确认删除该版本？").then(function(){return Fe(o.historyId)}).then(()=>{h(m.projectId),r.$modal.msgSuccess("删除成功")}).catch(()=>{})}function N(e,o){if(o.length===0)return!1;const I=o.map(c=>c.historyId).sort((c,g)=>g-c)[0];return e.historyId===I}return(e,o)=>{const i=v("el-button"),I=v("el-card"),c=v("el-input"),g=v("el-form-item"),u=v("el-form"),V=v("el-dialog"),se=v("upload-filled"),ae=v("el-icon"),ie=v("el-upload");return C(),w("div",Ce,[d("div",$e,[we,t(i,{class:"right-button",onClick:O},{default:l(()=>[p("添加原型")]),_:1})]),d("div",Ue,[(C(!0),w(q,null,H(a(k),(s,de)=>(C(),_e(I,{key:de,class:"prototype-card"},{header:l(()=>[d("div",Ve,[d("span",null,E(s.uploadDescription),1),d("div",xe,[t(i,{onClick:_=>G(s.projectFileId)},{default:l(()=>[p("修改")]),_:2},1032,["onClick"]),t(i,{onClick:_=>Q(s.projectFileId)},{default:l(()=>[p("删除")]),_:2},1032,["onClick"]),t(i,{onClick:_=>W(s.projectFileId)},{default:l(()=>[p("上传新版本")]),_:2},1032,["onClick"])])])]),default:l(()=>[(C(!0),w(q,null,H(s.versions,(_,R)=>(C(),w("div",{key:R,class:"version-item"},[d("div",Re,[d("span",{class:he(["version-number",{latest:N(_,s.versions)}])},E(_.version),3),d("div",Se,[t(i,{icon:"Edit",circle:"",onClick:B=>oe(R,_)},null,8,["onClick"]),t(i,{icon:"Delete",circle:"",type:"danger",onClick:B=>le(R,_)},null,8,["onClick"])])]),d("div",Ee,[d("p",null,E(_.description),1)]),N(_,s.versions)?(C(),w("div",Me,[t(i,{onClick:B=>ee(s.projectFileId)},{default:l(()=>[p("立即访问")]),_:2},1032,["onClick"])])):ve("",!0)]))),128))]),_:2},1024))),128))]),t(V,{modelValue:a(D),"onUpdate:modelValue":o[2]||(o[2]=s=>S(D)?D.value=s:null),title:"新增原型",width:"30%"},{footer:l(()=>[d("span",Pe,[t(i,{onClick:o[1]||(o[1]=s=>D.value=!1)},{default:l(()=>[p("取消")]),_:1}),t(i,{type:"primary",onClick:K},{default:l(()=>[p("确定")]),_:1})])]),default:l(()=>[t(u,{model:a(f),rules:L,ref_key:"formRef",ref:U,"label-width":"80px","label-position":"top"},{default:l(()=>[t(g,{label:"原型名称",prop:"name"},{default:l(()=>[t(c,{modelValue:a(f).uploadDescription,"onUpdate:modelValue":o[0]||(o[0]=s=>a(f).uploadDescription=s),placeholder:"请输入原型名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(V,{modelValue:a(F),"onUpdate:modelValue":o[5]||(o[5]=s=>S(F)?F.value=s:null),title:"编辑原型",width:"30%"},{footer:l(()=>[d("span",Le,[t(i,{onClick:o[4]||(o[4]=s=>F.value=!1)},{default:l(()=>[p("取消")]),_:1}),t(i,{type:"primary",onClick:J},{default:l(()=>[p("确定")]),_:1})])]),default:l(()=>[t(u,{model:a(f),rules:L,ref_key:"formRef",ref:U,"label-width":"80px","label-position":"top"},{default:l(()=>[t(g,{label:"原型名称",prop:"name"},{default:l(()=>[t(c,{modelValue:a(f).uploadDescription,"onUpdate:modelValue":o[3]||(o[3]=s=>a(f).uploadDescription=s),placeholder:"请输入原型名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(V,{title:a(n).title,modelValue:a(n).open,"onUpdate:modelValue":o[8]||(o[8]=s=>a(n).open=s),width:"500px","append-to-body":""},{footer:l(()=>[d("div",qe,[t(i,{type:"primary",icon:"UploadFilled",onClick:Z,loading:a(n).isUploading},{default:l(()=>[p("提交上传")]),_:1},8,["loading"]),t(i,{onClick:o[7]||(o[7]=s=>a(n).open=!1)},{default:l(()=>[p("取消")]),_:1})])]),default:l(()=>[d("div",ze,[t(u,{ref:"uploadFormRef",model:a(n).data,rules:a(T),"label-width":"0"},{default:l(()=>[t(g,{prop:"UploadDescription",class:"desc-input",style:{"margin-bottom":"20px"}},{default:l(()=>[t(c,{modelValue:a(n).data.UploadDescription,"onUpdate:modelValue":o[6]||(o[6]=s=>a(n).data.UploadDescription=s),type:"textarea",rows:4,placeholder:"请输入版本描述（如：功能更新说明）",clearable:"","show-word-limit":"",maxlength:"200"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),t(ie,{ref:"uploadRef",class:"custom-upload",limit:1,accept:".zip",data:a(n).data,headers:a(n).headers,action:a(n).url,disabled:a(n).isUploading,"on-progress":X,"on-success":Y,"auto-upload":!1,drag:""},{tip:l(()=>[Be]),default:l(()=>[t(ae,{class:"el-icon--upload",style:{color:"#409EFF"}},{default:l(()=>[t(se)]),_:1}),Ne]),_:1},8,["data","headers","action","disabled"])])]),_:1},8,["title","modelValue"]),t(V,{modelValue:a(j),"onUpdate:modelValue":o[11]||(o[11]=s=>S(j)?j.value=s:null),title:"编辑",width:"30%"},{footer:l(()=>[d("span",He,[t(i,{onClick:o[10]||(o[10]=s=>j.value=!1)},{default:l(()=>[p("取消")]),_:1}),t(i,{type:"primary",onClick:te},{default:l(()=>[p("确定")]),_:1})])]),default:l(()=>[t(u,{model:a(y),rules:A,ref_key:"editDescriptionFormRef",ref:z,"label-position":"top","label-width":"120px"},{default:l(()=>[t(g,{label:"版本说明",prop:"UploadDescription"},{default:l(()=>[t(c,{modelValue:a(y).UploadDescription,"onUpdate:modelValue":o[9]||(o[9]=s=>a(y).UploadDescription=s),type:"textarea",rows:4,placeholder:"请输入文件描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Ge=ne(Ae,[["__scopeId","data-v-83ab6ebd"]]);export{Ge as default};
