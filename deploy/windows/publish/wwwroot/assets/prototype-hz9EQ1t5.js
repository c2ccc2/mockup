import{K as b,_ as re,C as de,e as ce,w as pe,r as k,D as S,L as ue,M as me,f as h,c as $,n as i,h as t,i as l,p,H,I as T,l as n,F as E,v as fe,x as ge,o as V,j as _e,k as ve,N as he,B as M}from"./index-BAo5QewB.js";function ye(r){return b({url:"/projectManager/projectfile/list",method:"post",data:r})}function Ie(r){return b({url:"/projectManager/filehistory/GetCustomPagedListAsync",method:"post",data:r})}function je(r){return b({url:"/projectManager/projectfile/Add",method:"put",data:r})}function ke(r){return b({url:"/projectManager/projectfile/updatename",method:"put",data:r})}function be(r){return b({url:"/projectManager/projectfile/Remove/"+r,method:"delete"})}function De(r){return b({url:"/projectManager/filehistory/Edit",method:"put",data:r})}function we(r){return b({url:"/projectManager/filehistory/Remove/"+r,method:"delete"})}const P=r=>(fe("data-v-5e91124a"),r=r(),ge(),r),Ce={class:"main"},Fe={class:"header"},Ve=P(()=>i("span",{class:"title"},"原型管理",-1)),$e={class:"content"},Ue={class:"card-header"},xe={class:"button-group"},Me={class:"version-header"},Re={class:"version-time"},Se={class:"version-actions"},Ee={class:"version-description"},Pe={key:0,class:"visit-link"},Le={class:"dialog-footer"},Ne={class:"dialog-footer"},ze={class:"upload-dialog"},Be={class:"desc-input",style:{"margin-bottom":"20px"}},Ae=P(()=>i("div",{class:"upload-text"},[i("p",{class:"main-text"},"拖拽文件到此区域 或"),i("em",{class:"click-text"},"点击选择文件")],-1)),He=P(()=>i("div",{class:"upload-tip"},[i("span",{style:{color:"#67C23A"}},"支持扩展名：.zip "),i("br"),i("span",{style:{color:"#909399"}},"（单个文件建议不超过10MB）")],-1)),Te={class:"dialog-footer"},qe={class:"dialog-footer"},Oe=de({name:"prototype"}),Ge=Object.assign(Oe,{props:{projectId:{type:[String,Number],required:!0}},setup(r){const{proxy:c}=ce(),m=r;pe(()=>m.projectId,o=>{console.log("项目ID变化:",o),y(o)});const L=k({pageIndex:1,pageSize:10,totalCount:0}),D=k([]),w=k(!1),C=k(!1),U=k(null),f=S({name:"",description:""}),N={uploadDescription:[{required:!0,message:"原型名称不能为空",trigger:"blur"},{max:50,message:"长度不能超过50个字符",trigger:"blur"}]},d=S({open:!1,title:"上传原型文件,zip格式",isUploading:!1,data:{UploadDescription:"",ProjectFileId:""},headers:{Authorization:"Bearer "+ue()},url:window.location.origin+"/projectManager/projectfile/AddFileToProjectFile"}),F=k(!1),I=S({historyId:"",UploadDescription:""}),q={UploadDescription:[{required:!0,message:"文件描述不能为空",trigger:"blur"}]},z=k(null);me(()=>{y(m.projectId)});function y(o){const e=String(o);console.log("加载数据:",o);let s={projectId:e,pageModel:L.value};ye(s).then(j=>{console.log("res",j),L.totalCount=j.total,D.value=j.rows,D.value.length>0&&Promise.all(D.value.map(async u=>{try{const v=await Ie({projectFileId:u.projectFileId,pageModel:{pageIndex:1,pageSize:10,totalCount:0}});u.versions=v.rows.map(g=>({version:`v${g.version}`,description:g.uploadDescription,time:g.updateTime,historyId:g.historyId,filePath:g.filePath,fileName:g.fileName}))}catch(v){console.error(`获取文件列表失败(ID:${u.projectFileId}):`,v),u.versions=[]}})),console.log("完整数据:",D.value)})}function O(){console.log("添加原型"),f.uploadDescription="",w.value=!0}async function G(){try{await U.value.validate();const o=await je({projectId:m.projectId,...f});o.code===200?(c.$modal.msgSuccess("新增成功"),w.value=!1,y(m.projectId)):c.$modal.msgError("添加失败："+o.message)}catch(o){console.error("表单验证失败:",o)}}function K(o){const e=D.value.find(s=>s.projectFileId===o);if(!e){c.$modal.msgError("未找到原型数据");return}Object.assign(f,{projectFileId:e.projectFileId,uploadDescription:e.uploadDescription}),C.value=!0}async function J(){try{await U.value.validate();const o=await ke({projectId:m.projectId,...f});o.code===200?(c.$modal.msgSuccess("修改成功"),C.value=!1,y(m.projectId)):c.$modal.msgError("修改失败："+o.message)}catch(o){console.error("表单验证失败:",o)}}async function Q(o){try{await c.$modal.confirm("确定删除该原型？","警告",{type:"warning"})&&(await be(o.toString())).code===200&&(c.$modal.msgSuccess("删除成功"),y(m.projectId))}catch{console.log("取消删除")}}function W(o){d.data.ProjectFileId=o,d.open=!0}const X=(o,e,s)=>{d.isUploading=!0},Y=(o,e,s)=>{d.open=!1,d.isUploading=!1,c.$refs.uploadRef.handleRemove(e),c.$alert("<div style='overflow: auto;overflow-x: hidden;max-height: 70vh;padding: 10px 20px 0;'>"+o.msg+"</div>","上传结果",{dangerouslyUseHTMLString:!0}),o.code===200?(c.$modal.msgSuccess("上传成功"),y(m.projectId)):c.$modal.msgError("上传失败："+o.message)};function Z(){console.log("上传地址:",d.url),c.$refs.uploadRef.submit()}function ee(o){console.log("projectFileId:",o);const s="/".replace(/\/?$/,"")+"/upload/projectunzip/"+o+"/start.html#&g=1";window.open(s,"_blank")}function oe(o,e){I.historyId=e.historyId,I.UploadDescription=e.description,F.value=!0}async function te(){try{await z.value.validate();const o=await De({historyId:I.historyId,uploadDescription:I.UploadDescription});o.code===200?(c.$modal.msgSuccess("修改成功"),F.value=!1,y(m.projectId)):c.$modal.msgError("修改失败："+o.message)}catch(o){console.error("表单验证失败:",o)}}function le(o,e){console.log("删除:",e),c.$modal.confirm("是否确认删除该版本？").then(function(){return we(e.historyId)}).then(()=>{y(m.projectId),c.$modal.msgSuccess("删除成功")}).catch(()=>{})}function B(o,e){if(e.length===0)return!1;const j=e.map(u=>u.historyId).sort((u,v)=>v-u)[0];return o.historyId===j}return(o,e)=>{const s=h("el-button"),j=h("el-card"),u=h("el-input"),v=h("el-form-item"),g=h("el-form"),x=h("el-dialog"),ae=h("upload-filled"),se=h("el-icon"),ie=h("el-upload");return V(),$("div",Ce,[i("div",Fe,[Ve,t(s,{class:"right-button",onClick:O},{default:l(()=>[p("添加原型")]),_:1})]),i("div",$e,[(V(!0),$(H,null,T(n(D),(a,ne)=>(V(),_e(j,{key:ne,class:"prototype-card"},{header:l(()=>[i("div",Ue,[i("span",null,M(a.uploadDescription),1),i("div",xe,[t(s,{onClick:_=>K(a.projectFileId)},{default:l(()=>[p("修改")]),_:2},1032,["onClick"]),t(s,{onClick:_=>Q(a.projectFileId)},{default:l(()=>[p("删除")]),_:2},1032,["onClick"]),t(s,{onClick:_=>W(a.projectFileId)},{default:l(()=>[p("上传新版本")]),_:2},1032,["onClick"])])])]),default:l(()=>[(V(!0),$(H,null,T(a.versions,(_,R)=>(V(),$("div",{key:R,class:"version-item"},[i("div",Me,[i("span",{class:he(["version-number",{latest:B(_,a.versions)}])},[p(M(_.version)+" ",1),i("span",Re,M(_.time),1)],2),i("div",Se,[t(s,{icon:"Edit",circle:"",onClick:A=>oe(R,_)},null,8,["onClick"]),t(s,{icon:"Delete",circle:"",type:"danger",onClick:A=>le(R,_)},null,8,["onClick"])])]),i("div",Ee,[i("p",null,M(_.description),1)]),B(_,a.versions)?(V(),$("div",Pe,[t(s,{onClick:A=>ee(a.projectFileId)},{default:l(()=>[p("立即访问")]),_:2},1032,["onClick"])])):ve("",!0)]))),128))]),_:2},1024))),128))]),t(x,{modelValue:n(w),"onUpdate:modelValue":e[2]||(e[2]=a=>E(w)?w.value=a:null),title:"新增原型",width:"30%"},{footer:l(()=>[i("span",Le,[t(s,{onClick:e[1]||(e[1]=a=>w.value=!1)},{default:l(()=>[p("取消")]),_:1}),t(s,{type:"primary",onClick:G},{default:l(()=>[p("确定")]),_:1})])]),default:l(()=>[t(g,{model:n(f),rules:N,ref_key:"formRef",ref:U,"label-width":"80px","label-position":"top"},{default:l(()=>[t(v,{label:"原型名称",prop:"name"},{default:l(()=>[t(u,{modelValue:n(f).uploadDescription,"onUpdate:modelValue":e[0]||(e[0]=a=>n(f).uploadDescription=a),placeholder:"请输入原型名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(x,{modelValue:n(C),"onUpdate:modelValue":e[5]||(e[5]=a=>E(C)?C.value=a:null),title:"编辑原型",width:"30%"},{footer:l(()=>[i("span",Ne,[t(s,{onClick:e[4]||(e[4]=a=>C.value=!1)},{default:l(()=>[p("取消")]),_:1}),t(s,{type:"primary",onClick:J},{default:l(()=>[p("确定")]),_:1})])]),default:l(()=>[t(g,{model:n(f),rules:N,ref_key:"formRef",ref:U,"label-width":"80px","label-position":"top"},{default:l(()=>[t(v,{label:"原型名称",prop:"name"},{default:l(()=>[t(u,{modelValue:n(f).uploadDescription,"onUpdate:modelValue":e[3]||(e[3]=a=>n(f).uploadDescription=a),placeholder:"请输入原型名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(x,{title:n(d).title,modelValue:n(d).open,"onUpdate:modelValue":e[8]||(e[8]=a=>n(d).open=a),width:"500px","append-to-body":""},{footer:l(()=>[i("div",Te,[t(s,{type:"primary",icon:"UploadFilled",onClick:Z,loading:n(d).isUploading},{default:l(()=>[p("提交上传1")]),_:1},8,["loading"]),t(s,{onClick:e[7]||(e[7]=a=>n(d).open=!1)},{default:l(()=>[p("取消")]),_:1})])]),default:l(()=>[i("div",ze,[i("div",Be,[t(u,{modelValue:n(d).data.UploadDescription,"onUpdate:modelValue":e[6]||(e[6]=a=>n(d).data.UploadDescription=a),type:"textarea",rows:4,placeholder:"请输入版本描述（如：功能更新说明）",clearable:"","show-word-limit":"",maxlength:"200"},null,8,["modelValue"])]),t(ie,{ref:"uploadRef",class:"custom-upload",limit:1,accept:".zip",data:n(d).data,headers:n(d).headers,action:n(d).url,disabled:n(d).isUploading,"on-progress":X,"on-success":Y,"auto-upload":!1,drag:""},{tip:l(()=>[He]),default:l(()=>[t(se,{class:"el-icon--upload",style:{color:"#409EFF"}},{default:l(()=>[t(ae)]),_:1}),Ae]),_:1},8,["data","headers","action","disabled"])])]),_:1},8,["title","modelValue"]),t(x,{modelValue:n(F),"onUpdate:modelValue":e[11]||(e[11]=a=>E(F)?F.value=a:null),title:"编辑",width:"30%"},{footer:l(()=>[i("span",qe,[t(s,{onClick:e[10]||(e[10]=a=>F.value=!1)},{default:l(()=>[p("取消")]),_:1}),t(s,{type:"primary",onClick:te},{default:l(()=>[p("确定")]),_:1})])]),default:l(()=>[t(g,{model:n(I),rules:q,ref_key:"editDescriptionFormRef",ref:z,"label-position":"top","label-width":"120px"},{default:l(()=>[t(v,{label:"版本说明",prop:"UploadDescription"},{default:l(()=>[t(u,{modelValue:n(I).UploadDescription,"onUpdate:modelValue":e[9]||(e[9]=a=>n(I).UploadDescription=a),type:"textarea",rows:4,placeholder:"请输入文件描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Je=re(Ge,[["__scopeId","data-v-5e91124a"]]);export{Je as default};
