import{D as P,_ as Te,e as Ie,u as De,w as Se,r,B as we,G as Ne,f as _,M as je,c as i,j as t,k as D,l as d,N as $e,i as m,p as f,P as E,t as l,H as V,I as z,h as c,y as Me,z as xe,o}from"./index-CR6ovanu.js";import Ee from"./StartTaskDialog-DQv5ARtA.js";import{_ as Ve,I as ze}from"./ItemDetailDialog-FOfzjPLO.js";import Pe from"./CreateTaskDialog-BiJjOoei.js";import"./tasks-mvyL4cZG.js";import"./projectUser-CylPsKmU.js";function Le(u){return P({url:"/project/board/task/unstart",method:"post",data:u})}function Be(u){return P({url:"/project/board/task/completed",method:"post",data:u})}function Ue(u){return P({url:"/project/board/stages/"+u,method:"get"})}function Re(u){return P({url:"/project/board/taskItems/"+u,method:"get"})}const L=u=>(Me("data-v-6ffb11ad"),u=u(),xe(),u),Ae={class:"kanban-container"},Oe={class:"kanban-header"},Fe=L(()=>t("h2",null,"项目任务看板",-1)),qe={class:"header-actions"},He={class:"kanban-columns"},Je={class:"column-header"},Ke=L(()=>t("span",{class:"column-title"},"将要做",-1)),Ge={class:"column-count"},We={class:"column-body"},Xe=["onClick"],Ye={class:"task-header"},Ze={class:"task-title"},Qe={class:"task-meta"},et={class:"meta-item task-type-tag"},tt={key:0,class:"meta-item"},st={key:0,class:"empty-state"},at={class:"column-header"},ot=L(()=>t("span",{class:"column-title"},"正在做",-1)),nt={class:"column-count"},lt={class:"column-body"},ct={class:"sub-columns-container"},it={class:"sub-column-header"},rt={class:"sub-column-title"},dt={class:"sub-column-count"},ut={class:"sub-column-body"},mt=["onClick"],pt={class:"task-header"},vt={class:"task-title-container"},_t={class:"task-title"},ht={key:0,class:"task-priority-tag"},yt={class:"task-meta-line"},gt={class:"task-status-tag"},kt={key:0,class:"task-assignee-info"},ft={class:"task-footer-info"},bt={key:0,class:"task-type-tag"},Ct={key:1,class:"task-date-info"},Tt={key:2,class:"task-deadline-info"},It={key:0,class:"empty-state"},Dt={key:0,class:"empty-state"},St={class:"column-header"},wt=L(()=>t("span",{class:"column-title"},"已完成",-1)),Nt={class:"column-count"},jt={class:"column-body"},$t=["onClick"],Mt={class:"task-header"},xt={class:"task-title-container"},Et={class:"completed-badge"},Vt={class:"task-title"},zt={class:"task-content"},Pt={class:"meta-item task-type-tag"},Lt={class:"task-deadline"},Bt={key:0,class:"empty-state"},Ut={__name:"index",props:{projectId:{type:[String,Number],required:!0},projectName:{type:String,default:""}},setup(u){const{proxy:p}=Ie(),Z=De(),b=u;Se(()=>Z.query,(e,s)=>{e&&s&&JSON.stringify(e)!==JSON.stringify(s)&&ye()},{deep:!0});const B=r("todo"),v=r([]),h=r([]),y=r([]),S=r([]),U=we(()=>!S.value||!Array.isArray(S.value)?[]:[...S.value].sort((e,s)=>e.stageOrder-s.stageOrder)),Q=r({}),j=r(!1),g=r(!1),ee=r({}),R=r(""),C=r(!1),A=r(null),w=async()=>{try{const e={projectId:b.projectId,taskName:"",status:null},s=await Le(e);s.code===200&&(v.value=s.rows||[])}catch(e){console.error('获取"将要做"任务列表失败:',e),p.$modal.msgError('获取"将要做"任务列表失败'),v.value=[]}},O=async()=>{try{const e={projectId:b.projectId,taskName:"",status:null},s=await Be(e);s.code===200&&(y.value=s.rows||[])}catch(e){console.error('获取"已完成"任务列表失败:',e),p.$modal.msgError('获取"已完成"任务列表失败'),y.value=[]}},K=async()=>{try{console.log("获取项目阶段列表...",b.projectId);const e=await Ue(b.projectId);e.code===200&&(S.value=e.data||[])}catch(e){console.error("获取项目阶段列表失败:",e),p.$modal.msgError("获取项目阶段列表失败"),S.value=[]}},$=async()=>{try{const e=await Re(b.projectId);console.log('获取"正在做"任务列表...',e),e.code===200&&(h.value=e.data||[])}catch(e){console.error('获取"正在做"任务列表失败:',e),p.$modal.msgError('获取"正在做"任务列表失败'),h.value=[]}},F=e=>!h.value||!Array.isArray(h.value)?[]:h.value.filter(s=>s.stageId===e),te=()=>h.value?h.value.length:0,M=e=>e?new Date(e).toLocaleDateString("zh-CN"):"无",q=e=>({0:"success",1:"primary",2:"danger",3:"info",4:"info"})[e]||"info",T=r(!1),k=r(null),G=e=>{console.log("查看任务详情:",e),k.value=e.taskId,T.value=!0},se=e=>{k.value=e.taskId},ae=()=>{T.value=!1,k.value=null},W=r(null),oe=(e,s="")=>{console.log("查看任务项详情:",e),W.value=e.itemId,R.value=s,g.value=!0},ne=()=>{g.value=!1,ee.value={},R.value=""},le=async e=>{try{g.value=!1,e.taskData?k.value=e.taskData.taskId:e.taskId&&(k.value=e.taskId),T.value=!0}catch(s){console.error("获取任务详情失败:",s),p.$modal.msgError("获取任务详情失败: "+(s.message||""))}finally{taskDetailLoading.value=!1}},ce=e=>({0:"低",1:"中",2:"高",3:"紧急"})[e]||"未知",ie=e=>({0:"info",1:"primary",2:"warning",3:"danger"})[e]||"info",re=e=>({0:"未分配",1:"进行中",2:"已完成未确认",3:"已略过",4:"已完成"})[e]||"未知状态",de=e=>({0:"info",1:"primary",2:"warning",3:"danger",4:"success"})[e]||"info",ue=()=>{A.value=null,C.value=!0},me=async e=>{try{p.$modal.msgSuccess("任务创建成功"),C.value=!1,await w()}catch(s){console.error("刷新数据失败:",s),p.$modal.msgError("数据刷新失败")}},pe=()=>{C.value=!1,A.value=null},ve=async e=>{try{p.$modal.msgSuccess("任务启动成功"),j.value=!1,await X()}catch(s){console.error("刷新数据失败:",s),p.$modal.msgError("数据刷新失败")}},X=async()=>{await Promise.all([w(),$()])},_e=async e=>{console.log("Handle item complete success called"),console.log("Response:",e);try{g.value=!1,await H()}catch(s){console.error("刷新数据失败:",s),p.$modal.msgError("数据刷新失败")}},he=async()=>{await H()},H=async()=>{console.log("开始刷新看板数据..."),await Promise.all([w(),$(),O()])};Ne(()=>{w(),O(),K(),$()});const ye=()=>{w(),O(),K(),$()};return(e,s)=>{const ge=_("el-button"),N=_("el-tag"),J=_("Calendar"),I=_("el-icon"),x=_("el-empty"),ke=_("CircleCheckFilled"),fe=_("User"),be=_("Check"),Ce=je("hasPermi");return o(),i("div",Ae,[t("div",Oe,[Fe,t("div",qe,[$e((o(),D(ge,{type:"primary",onClick:ue},{default:m(()=>[f("新增任务")]),_:1})),[[Ce,["project:task:add"]]])])]),t("div",He,[t("div",{class:E(["kanban-column todo-column",{"column-active":B.value==="todo"}])},[t("div",Je,[Ke,t("span",Ge,l(v.value?v.value.length:0),1)]),t("div",We,[(o(!0),i(V,null,z(v.value,(a,n)=>(o(),i("div",{key:a.taskId,class:"task-card",onClick:Y=>G(a)},[t("div",Ye,[t("span",Ze,l(a.taskName),1)]),t("div",Qe,[t("div",et,[c(N,{type:q(a.taskType),size:"small"},{default:m(()=>[f(l(a.taskTypeLabel),1)]),_:2},1032,["type"])]),a.deadline?(o(),i("div",tt,[c(I,null,{default:m(()=>[c(J)]),_:1}),t("span",null," 预计："+l(M(a.deadline)),1)])):d("",!0)])],8,Xe))),128)),!v.value||v.value.length===0?(o(),i("div",st,[c(x,{description:"暂无待办任务"})])):d("",!0)])],2),t("div",{class:E(["kanban-column doing-column",{"column-active":B.value==="doing"}])},[t("div",at,[ot,t("span",nt,l(te()),1)]),t("div",lt,[t("div",ct,[(o(!0),i(V,null,z(U.value,a=>(o(),i("div",{key:a.stageId,class:"sub-column"},[t("div",it,[t("span",rt,l(a.name),1),t("span",dt,l(F(a.stageId).length),1)]),t("div",ut,[(o(!0),i(V,null,z(F(a.stageId),n=>(o(),i("div",{key:n.taskId,class:E(["task-card",{"pending-confirmation":n.statusCode===2}]),onClick:Y=>oe(n)},[t("div",pt,[t("div",vt,[t("span",_t,[n.statusCode===2?(o(),D(I,{key:0,class:"completed-check-icon"},{default:m(()=>[c(ke)]),_:1})):d("",!0),f(" "+l(n.itemName)+l(n.itemName?"的":"")+l(a.name)+"任务 ",1)])]),n.levelCode!==void 0&&n.levelCode!==null?(o(),i("div",ht,[c(N,{type:ie(n.levelCode),size:"small"},{default:m(()=>[f(l(ce(n.levelCode)),1)]),_:2},1032,["type"])])):d("",!0)]),t("div",yt,[t("div",gt,[c(N,{type:de(n.statusCode),size:"small"},{default:m(()=>[f(l(re(n.statusCode)),1)]),_:2},1032,["type"])]),n.assignToName?(o(),i("div",kt,[c(I,null,{default:m(()=>[c(fe)]),_:1}),t("span",null,l(n.assignToName),1)])):d("",!0)]),t("div",ft,[n.taskTypeLabel?(o(),i("div",bt,[c(N,{type:q(n.taskType),size:"small"},{default:m(()=>[f(l(n.taskTypeLabel),1)]),_:2},1032,["type"])])):d("",!0),n.statusCode===2&&n.completeTime?(o(),i("div",Ct,[c(I,null,{default:m(()=>[c(J)]),_:1}),t("span",null,"完成时间: "+l(M(n.completeTime)),1)])):n.deadDate?(o(),i("div",Tt,[c(I,null,{default:m(()=>[c(J)]),_:1}),t("span",null,"预计完成: "+l(M(n.deadDate)),1)])):d("",!0)])],10,mt))),128)),F(a.stageId).length===0?(o(),i("div",It,[c(x,{description:"暂无任务","image-size":60})])):d("",!0)])]))),128)),!U.value||U.value.length===0?(o(),i("div",Dt,[c(x,{description:"暂无阶段信息"})])):d("",!0)])])],2),t("div",{class:E(["kanban-column done-column",{"column-active":B.value==="done"}])},[t("div",St,[wt,t("span",Nt,l(y.value?y.value.length:0),1)]),t("div",jt,[(o(!0),i(V,null,z(y.value,(a,n)=>(o(),i("div",{key:a.taskId,class:"task-card",onClick:Y=>G(a)},[t("div",Mt,[t("div",xt,[t("div",Et,[c(I,null,{default:m(()=>[c(be)]),_:1})]),t("span",Vt,l(a.taskName),1)])]),t("div",zt,[t("div",Pt,[c(N,{type:q(a.taskType),size:"small"},{default:m(()=>[f(l(a.taskTypeLabel),1)]),_:2},1032,["type"]),t("span",Lt," 完成时间:"+l(M(a.completedDate)),1)])])],8,$t))),128)),!y.value||y.value.length===0?(o(),i("div",Bt,[c(x,{description:"暂无已完成任务"})])):d("",!0)])],2)]),T.value&&k.value?(o(),D(Ve,{key:0,visible:T.value,"onUpdate:visible":s[0]||(s[0]=a=>T.value=a),"task-id":k.value,"show-actions":!0,"show-navigation":!0,"task-list":v.value,onNavigate:se,onRefresh:H,onClose:ae},null,8,["visible","task-id","task-list"])):d("",!0),C.value?(o(),D(Pe,{key:1,visible:C.value,"onUpdate:visible":s[1]||(s[1]=a=>C.value=a),"project-id":b.projectId,"task-id":A.value,onSuccess:me,onClose:pe},null,8,["visible","project-id","task-id"])):d("",!0),j.value?(o(),D(Ee,{key:2,visible:j.value,"onUpdate:visible":s[2]||(s[2]=a=>j.value=a),task:Q.value,onSuccess:ve,onClose:X},null,8,["visible","task"])):d("",!0),g.value?(o(),D(ze,{key:3,visible:g.value,"onUpdate:visible":s[3]||(s[3]=a=>g.value=a),"item-id":W.value,"stage-name":R.value,onClose:ne,onSuccess:_e,onViewTaskDetail:le,onRefresh:he},null,8,["visible","item-id","stage-name"])):d("",!0)])}}},Jt=Te(Ut,[["__scopeId","data-v-6ffb11ad"]]);export{Jt as default};
