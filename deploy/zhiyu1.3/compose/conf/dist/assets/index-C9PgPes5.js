import{_ as we,e as be,u as Te,w as Se,r as d,J as M,G as Ce,ad as Ie,f as l,c as v,l as w,k as I,j as N,h as o,i as s,n as Ne,o as i,H as $e,I as De,p,t as B,X as xe}from"./index-CR6ovanu.js";import{l as ze,d as Ve,p as Ee,g as Be}from"./tasks-mvyL4cZG.js";import Pe from"./StartTaskDialog-DQv5ARtA.js";import je from"./CreateTaskDialog-BiJjOoei.js";import{T as Le}from"./ItemDetailDialog-FOfzjPLO.js";import"./projectUser-CylPsKmU.js";const Me={class:"app-container"},Re={key:0},Ue={class:"header"},qe={class:"content"},Je={key:0,class:"loading"},Oe={key:1,class:"empty"},Fe={key:2},Ke={class:"el-dropdown-link",align:"center"},Ae={class:"pagination"},Ge={key:1},He={__name:"index",props:{projectId:{type:[String,Number],required:!0}},setup(R){const{proxy:n}=be(),P=R,U=Te();Se(()=>U.query,(e,t)=>{e&&t&&JSON.stringify(e)!==JSON.stringify(t)&&z()},{deep:!0});const c=d("list"),$=d(null),m=d(null),j=d(!1),_=M({taskName:"",status:null}),r=M({currentPage:1,pageSize:10,total:0}),h=d([]),b=d(!1),D=d({}),y=d(!1),k=d(!1),T=d(null),q=[{value:0,label:"待处理"},{value:1,label:"进行中"},{value:2,label:"已完成"},{value:3,label:"已取消"}],u=async()=>{try{b.value=!0;const e={projectId:P.projectId,taskName:_.taskName,status:_.status,pageNum:r.currentPage,pageSize:r.pageSize},t=await ze(e);t.code===200?(h.value=t.rows||[],r.total=t.total||0):n.$modal.msgError(t.msg||"获取任务列表失败")}catch(e){console.error("获取任务列表失败:",e),n.$modal.msgError("获取任务列表失败")}finally{b.value=!1}},S=async e=>{try{j.value=!0;const t=await Be(e);t.code===200?(m.value=t.data,c.value="detail"):n.$modal.msgError(t.msg||"获取任务详情失败")}catch(t){console.error("获取任务详情失败:",t),n.$modal.msgError("获取任务详情失败")}finally{j.value=!1}},L=()=>{r.currentPage=1,u()},J=()=>{_.taskName="",_.status=null,r.currentPage=1,u()},O=e=>{r.pageSize=e,u()},F=e=>{r.currentPage=e,u()},K=e=>({0:"待处理",1:"进行中",2:"已完成",3:"已取消"})[e]||"未知状态",A=e=>({0:"info",1:"primary",2:"success",3:"danger"})[e]||"info",G=e=>e?new Date(e).toLocaleDateString("zh-CN"):"无",H=e=>{$.value=e.taskId,c.value="detail"},x=()=>{c.value="list",m.value=null},X=async()=>{try{await u(),c.value==="detail"&&m.value&&m.value.taskId&&await S(m.value.taskId)}catch(e){console.error("刷新任务详情失败:",e),n.$modal.msgError("数据刷新失败")}},W=()=>{console.log("启动任务对话框已关闭")},Y=()=>{T.value=null,k.value=!0},Z=e=>{console.log("编辑任务:",e),T.value=e.taskId,k.value=!0},Q=async e=>{try{n.$modal.msgSuccess(e.isEdit?"任务更新成功":"任务创建成功"),k.value=!1,c.value==="list"?u():m.value&&m.value.taskId&&S(m.value.taskId)}catch(t){console.error("刷新数据失败:",t),n.$modal.msgError("数据刷新失败")}},ee=()=>{T.value=null,k.value=!1},te=e=>{const{action:t,row:f}=e;switch(t){case"start":oe(f);break;case"pause":le(f);break;case"edit":Z(f);break;case"delete":ae(f);break}},ae=e=>{n.$modal.confirm("确定要删除该任务吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const t=await Ve(e.taskId);t.code===200?(n.$modal.msgSuccess("删除成功"),c.value==="list"?u():x()):n.$modal.msgError(t.msg||"删除失败")}catch(t){console.modal("删除任务失败:",t),n.$modal.msgError("删除任务失败")}}).catch(()=>{})},oe=async e=>{console.log("准备启动任务:",e),e&&e.taskId?(D.value=e,await xe(),y.value=!0,console.log("启动任务对话框已打开，传递的任务:",e)):(n.$message.error("任务信息不完整，无法启动"),console.error("任务缺少 taskId:",e))},se=async e=>{try{n.$message.success("任务启动成功"),y.value=!1,c.value==="list"?u():S(D.value.taskId)}catch(t){console.error("刷新数据失败:",t),n.$message.error("数据刷新失败")}},le=e=>{n.$confirm("确定要暂停该任务吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const t=await Ee(e.taskId);t.code===200?(n.$message.success("任务已暂停"),c.value==="list"?u():S(e.taskId)):n.$message.error(t.msg||"暂停失败")}catch(t){console.error("暂停任务失败:",t),n.$message.error("暂停任务失败")}}).catch(()=>{})},ne=e=>{$.value=e.taskId};Ce(()=>{z(),u()}),Ie(()=>{z()});const z=()=>{c.value="list",m.value=null};return(e,t)=>{const f=l("el-input"),V=l("el-form-item"),re=l("el-option"),ce=l("el-select"),E=l("el-button"),ie=l("el-form"),ue=l("el-skeleton"),de=l("el-empty"),g=l("el-table-column"),pe=l("el-tag"),me=l("el-link"),_e=l("el-progress"),ge=l("More"),ke=l("el-icon"),C=l("el-dropdown-item"),ve=l("el-dropdown-menu"),fe=l("el-dropdown"),he=l("el-table"),ye=l("el-pagination");return i(),v("div",Me,[c.value==="list"?(i(),v("div",Re,[N("div",Ue,[o(ie,{model:_,"label-width":"80px",inline:!0},{default:s(()=>[o(V,{label:"任务名称"},{default:s(()=>[o(f,{modelValue:_.taskName,"onUpdate:modelValue":t[0]||(t[0]=a=>_.taskName=a),placeholder:"请输入任务名称",clearable:"",onKeyup:Ne(L,["enter"])},null,8,["modelValue"])]),_:1}),o(V,{label:"任务状态"},{default:s(()=>[o(ce,{modelValue:_.status,"onUpdate:modelValue":t[1]||(t[1]=a=>_.status=a),placeholder:"请选择状态",clearable:"",style:{width:"150px"}},{default:s(()=>[(i(),v($e,null,De(q,a=>o(re,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),o(V,null,{default:s(()=>[o(E,{type:"primary",onClick:L,loading:b.value},{default:s(()=>[p(" 查询 ")]),_:1},8,["loading"]),o(E,{onClick:J},{default:s(()=>[p("重置")]),_:1}),o(E,{type:"success",onClick:Y},{default:s(()=>[p("新增任务")]),_:1})]),_:1})]),_:1},8,["model"])]),N("div",qe,[b.value&&h.value.length===0?(i(),v("div",Je,[o(ue,{rows:5,animated:""})])):h.value.length===0?(i(),v("div",Oe,[o(de,{description:"暂无任务数据"})])):(i(),v("div",Fe,[o(he,{data:h.value,stripe:"",style:{width:"100%"}},{default:s(()=>[o(g,{prop:"taskId",label:"ID",width:"80",align:"center"}),o(g,{prop:"taskTypeLabel",label:"类型",width:"100",align:"center"}),o(g,{prop:"status",label:"状态",width:"100",align:"center"},{default:s(a=>[o(pe,{type:A(a.row.status)},{default:s(()=>[p(B(K(a.row.status)),1)]),_:2},1032,["type"])]),_:1}),o(g,{prop:"taskName",label:"名称","show-overflow-tooltip":""},{default:s(a=>[o(me,{type:"primary",onClick:Xe=>H(a.row)},{default:s(()=>[p(B(a.row.taskName),1)]),_:2},1032,["onClick"])]),_:1}),o(g,{prop:"deadline",label:"截止日期",width:"120"},{default:s(a=>[p(B(G(a.row.deadline)),1)]),_:1}),o(g,{prop:"completionRate",label:"完成度",width:"150"},{default:s(a=>[o(_e,{percentage:a.row.completionRate,status:a.row.completionRate===100?"success":"","stroke-width":10},null,8,["percentage","status"])]),_:1}),o(g,{prop:"completedItems",label:"已完成项数",width:"120"}),o(g,{label:"操作",width:"80",align:"center"},{default:s(a=>[o(fe,{onCommand:te},{dropdown:s(()=>[o(ve,null,{default:s(()=>[a.row.status===0||a.row.status===3?(i(),I(C,{key:0,command:{action:"start",row:a.row}},{default:s(()=>[p(" 启动 ")]),_:2},1032,["command"])):w("",!0),a.row.status===1?(i(),I(C,{key:1,command:{action:"pause",row:a.row}},{default:s(()=>[p(" 暂停 ")]),_:2},1032,["command"])):w("",!0),o(C,{command:{action:"edit",row:a.row}},{default:s(()=>[p(" 编辑 ")]),_:2},1032,["command"]),o(C,{command:{action:"delete",row:a.row}},{default:s(()=>[p(" 删除 ")]),_:2},1032,["command"])]),_:2},1024)]),default:s(()=>[N("span",Ke,[o(ke,{class:"more-icon"},{default:s(()=>[o(ge)]),_:1})])]),_:2},1024)]),_:1})]),_:1},8,["data"]),N("div",Ae,[o(ye,{"current-page":r.currentPage,"onUpdate:currentPage":t[2]||(t[2]=a=>r.currentPage=a),"page-size":r.pageSize,"onUpdate:pageSize":t[3]||(t[3]=a=>r.pageSize=a),"page-sizes":[10,20,50,100],total:r.total,layout:"total, sizes, prev, pager, next, jumper",size:"default",onSizeChange:O,onCurrentChange:F},null,8,["current-page","page-size","total"])])]))])])):c.value==="detail"?(i(),v("div",Ge,[o(Le,{"task-id":$.value,"show-actions":!0,"show-navigation":!0,"task-list":h.value,onBack:x,onRefresh:X,onNavigate:ne,onClose:x},null,8,["task-id","task-list"])])):w("",!0),y.value?(i(),I(Pe,{key:2,visible:y.value,"onUpdate:visible":t[4]||(t[4]=a=>y.value=a),task:D.value,onSuccess:se,onClose:W},null,8,["visible","task"])):w("",!0),k.value?(i(),I(je,{key:3,visible:k.value,"onUpdate:visible":t[5]||(t[5]=a=>k.value=a),"project-id":P.projectId,"task-id":T.value,onSuccess:Q,onClose:ee},null,8,["visible","project-id","task-id"])):w("",!0)])}}},at=we(He,[["__scopeId","data-v-b7d319d0"]]);export{at as default};
