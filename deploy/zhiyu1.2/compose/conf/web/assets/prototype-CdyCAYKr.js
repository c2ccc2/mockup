import{K as b,_ as re,C as de,e as ce,w as pe,r as k,D as S,L as ue,M as me,f as h,c as $,n as s,h as t,i as l,p,H,I as T,l as i,F as E,v as fe,x as ge,o as V,j as _e,k as ve,N as he,B as M}from"./index-Bc-3QpSU.js";function ye(r){return b({url:"/projectManager/projectfile/list",method:"post",data:r})}function Ie(r){return b({url:"/projectManager/filehistory/GetCustomPagedListAsync",method:"post",data:r})}function je(r){return b({url:"/projectManager/projectfile/Add",method:"put",data:r})}function ke(r){return b({url:"/projectManager/projectfile/updatename",method:"put",data:r})}function be(r){return b({url:"/projectManager/projectfile/Remove/"+r,method:"delete"})}function De(r){return b({url:"/projectManager/filehistory/Edit",method:"put",data:r})}function Ce(r){return b({url:"/projectManager/filehistory/Remove/"+r,method:"delete"})}const P=r=>(fe("data-v-c097760a"),r=r(),ge(),r),Fe={class:"main"},we={class:"header"},Ve=P(()=>s("span",{class:"title"},"原型管理",-1)),$e={class:"content"},Ue={class:"card-header"},xe={class:"button-group"},Me={class:"version-header"},Re={class:"version-time"},Se={class:"version-actions"},Ee={class:"version-description"},Pe={key:0,class:"visit-link"},Le={class:"dialog-footer"},Ne={class:"dialog-footer"},ze={class:"upload-dialog"},Be={class:"desc-input",style:{"margin-bottom":"20px"}},Ae=P(()=>s("div",{class:"upload-text"},[s("p",{class:"main-text"},"拖拽文件到此区域 或"),s("em",{class:"click-text"},"点击选择文件")],-1)),He=P(()=>s("div",{class:"upload-tip"},[s("span",{style:{color:"#67C23A"}},"支持扩展名：.zip / .rar"),s("br"),s("span",{style:{color:"#909399"}},"（单个文件建议不超过100MB）")],-1)),Te={class:"dialog-footer"},qe={class:"dialog-footer"},Oe=de({name:"prototype"}),Ge=Object.assign(Oe,{props:{projectId:{type:[String,Number],required:!0}},setup(r){const{proxy:d}=ce(),m=r;pe(()=>m.projectId,o=>{console.log("项目ID变化:",o),y(o)});const L=k({pageIndex:1,pageSize:10,totalCount:0}),D=k([]),C=k(!1),F=k(!1),U=k(null),f=S({name:"",description:""}),N={uploadDescription:[{required:!0,message:"原型名称不能为空",trigger:"blur"},{max:50,message:"长度不能超过50个字符",trigger:"blur"}]},c=S({open:!1,title:"上传原型文件,zip格式",isUploading:!1,data:{UploadDescription:"",ProjectFileId:""},headers:{Authorization:"Bearer "+ue()},url:"/api/projectManager/projectfile/AddFileToProjectFile"}),w=k(!1),I=S({historyId:"",UploadDescription:""}),q={UploadDescription:[{required:!0,message:"文件描述不能为空",trigger:"blur"}]},z=k(null);me(()=>{y(m.projectId)});function y(o){const e=String(o);console.log("加载数据:",o);let n={projectId:e,pageModel:L.value};ye(n).then(j=>{console.log("res",j),L.totalCount=j.total,D.value=j.rows,D.value.length>0&&Promise.all(D.value.map(async u=>{try{const v=await Ie({projectFileId:u.projectFileId,pageModel:{pageIndex:1,pageSize:10,totalCount:0}});u.versions=v.rows.map(g=>({version:`v${g.version}`,description:g.uploadDescription,time:g.updateTime,historyId:g.historyId,filePath:g.filePath,fileName:g.fileName}))}catch(v){console.error(`获取文件列表失败(ID:${u.projectFileId}):`,v),u.versions=[]}})),console.log("完整数据:",D.value)})}function O(){console.log("添加原型"),f.uploadDescription="",C.value=!0}async function G(){try{await U.value.validate();const o=await je({projectId:m.projectId,...f});o.code===200?(d.$modal.msgSuccess("新增成功"),C.value=!1,y(m.projectId)):d.$modal.msgError("添加失败："+o.message)}catch(o){console.error("表单验证失败:",o)}}function K(o){const e=D.value.find(n=>n.projectFileId===o);if(!e){d.$modal.msgError("未找到原型数据");return}Object.assign(f,{projectFileId:e.projectFileId,uploadDescription:e.uploadDescription}),F.value=!0}async function J(){try{await U.value.validate();const o=await ke({projectId:m.projectId,...f});o.code===200?(d.$modal.msgSuccess("修改成功"),F.value=!1,y(m.projectId)):d.$modal.msgError("修改失败："+o.message)}catch(o){console.error("表单验证失败:",o)}}async function Q(o){try{await d.$modal.confirm("确定删除该原型？","警告",{type:"warning"})&&(await be(o.toString())).code===200&&(d.$modal.msgSuccess("删除成功"),y(m.projectId))}catch{console.log("取消删除")}}function W(o){c.data.ProjectFileId=o,c.open=!0}const X=(o,e,n)=>{c.isUploading=!0},Y=(o,e,n)=>{c.open=!1,c.isUploading=!1,d.$refs.uploadRef.handleRemove(e),d.$alert("<div style='overflow: auto;overflow-x: hidden;max-height: 70vh;padding: 10px 20px 0;'>"+o.msg+"</div>","上传结果",{dangerouslyUseHTMLString:!0}),o.code===200?(d.$modal.msgSuccess("上传成功"),y(m.projectId)):d.$modal.msgError("上传失败："+o.message)};function Z(){d.$refs.uploadRef.submit()}function ee(o){console.log("projectFileId:",o);const e="/api/upload/projectunzip/"+o+"/start.html";console.log("访问链接:",e),window.open(e,"_blank")}function oe(o,e){I.historyId=e.historyId,I.UploadDescription=e.description,w.value=!0}async function te(){try{await z.value.validate();const o=await De({historyId:I.historyId,uploadDescription:I.UploadDescription});o.code===200?(d.$modal.msgSuccess("修改成功"),w.value=!1,y(m.projectId)):d.$modal.msgError("修改失败："+o.message)}catch(o){console.error("表单验证失败:",o)}}function le(o,e){console.log("删除:",e),d.$modal.confirm("是否确认删除该版本？").then(function(){return Ce(e.historyId)}).then(()=>{y(m.projectId),d.$modal.msgSuccess("删除成功")}).catch(()=>{})}function B(o,e){if(e.length===0)return!1;const j=e.map(u=>u.historyId).sort((u,v)=>v-u)[0];return o.historyId===j}return(o,e)=>{const n=h("el-button"),j=h("el-card"),u=h("el-input"),v=h("el-form-item"),g=h("el-form"),x=h("el-dialog"),ae=h("upload-filled"),se=h("el-icon"),ie=h("el-upload");return V(),$("div",Fe,[s("div",we,[Ve,t(n,{class:"right-button",onClick:O},{default:l(()=>[p("添加原型")]),_:1})]),s("div",$e,[(V(!0),$(H,null,T(i(D),(a,ne)=>(V(),_e(j,{key:ne,class:"prototype-card"},{header:l(()=>[s("div",Ue,[s("span",null,M(a.uploadDescription),1),s("div",xe,[t(n,{onClick:_=>K(a.projectFileId)},{default:l(()=>[p("修改")]),_:2},1032,["onClick"]),t(n,{onClick:_=>Q(a.projectFileId)},{default:l(()=>[p("删除")]),_:2},1032,["onClick"]),t(n,{onClick:_=>W(a.projectFileId)},{default:l(()=>[p("上传新版本")]),_:2},1032,["onClick"])])])]),default:l(()=>[(V(!0),$(H,null,T(a.versions,(_,R)=>(V(),$("div",{key:R,class:"version-item"},[s("div",Me,[s("span",{class:he(["version-number",{latest:B(_,a.versions)}])},[p(M(_.version)+" ",1),s("span",Re,M(_.time),1)],2),s("div",Se,[t(n,{icon:"Edit",circle:"",onClick:A=>oe(R,_)},null,8,["onClick"]),t(n,{icon:"Delete",circle:"",type:"danger",onClick:A=>le(R,_)},null,8,["onClick"])])]),s("div",Ee,[s("p",null,M(_.description),1)]),B(_,a.versions)?(V(),$("div",Pe,[t(n,{onClick:A=>ee(a.projectFileId)},{default:l(()=>[p("立即访问")]),_:2},1032,["onClick"])])):ve("",!0)]))),128))]),_:2},1024))),128))]),t(x,{modelValue:i(C),"onUpdate:modelValue":e[2]||(e[2]=a=>E(C)?C.value=a:null),title:"新增原型",width:"30%"},{footer:l(()=>[s("span",Le,[t(n,{onClick:e[1]||(e[1]=a=>C.value=!1)},{default:l(()=>[p("取消")]),_:1}),t(n,{type:"primary",onClick:G},{default:l(()=>[p("确定")]),_:1})])]),default:l(()=>[t(g,{model:i(f),rules:N,ref_key:"formRef",ref:U,"label-width":"80px","label-position":"top"},{default:l(()=>[t(v,{label:"原型名称",prop:"name"},{default:l(()=>[t(u,{modelValue:i(f).uploadDescription,"onUpdate:modelValue":e[0]||(e[0]=a=>i(f).uploadDescription=a),placeholder:"请输入原型名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(x,{modelValue:i(F),"onUpdate:modelValue":e[5]||(e[5]=a=>E(F)?F.value=a:null),title:"编辑原型",width:"30%"},{footer:l(()=>[s("span",Ne,[t(n,{onClick:e[4]||(e[4]=a=>F.value=!1)},{default:l(()=>[p("取消")]),_:1}),t(n,{type:"primary",onClick:J},{default:l(()=>[p("确定")]),_:1})])]),default:l(()=>[t(g,{model:i(f),rules:N,ref_key:"formRef",ref:U,"label-width":"80px","label-position":"top"},{default:l(()=>[t(v,{label:"原型名称",prop:"name"},{default:l(()=>[t(u,{modelValue:i(f).uploadDescription,"onUpdate:modelValue":e[3]||(e[3]=a=>i(f).uploadDescription=a),placeholder:"请输入原型名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(x,{title:i(c).title,modelValue:i(c).open,"onUpdate:modelValue":e[8]||(e[8]=a=>i(c).open=a),width:"500px","append-to-body":""},{footer:l(()=>[s("div",Te,[t(n,{type:"primary",icon:"UploadFilled",onClick:Z,loading:i(c).isUploading},{default:l(()=>[p("提交上传")]),_:1},8,["loading"]),t(n,{onClick:e[7]||(e[7]=a=>i(c).open=!1)},{default:l(()=>[p("取消")]),_:1})])]),default:l(()=>[s("div",ze,[s("div",Be,[t(u,{modelValue:i(c).data.UploadDescription,"onUpdate:modelValue":e[6]||(e[6]=a=>i(c).data.UploadDescription=a),type:"textarea",rows:4,placeholder:"请输入版本描述（如：功能更新说明）",clearable:"","show-word-limit":"",maxlength:"200"},null,8,["modelValue"])]),t(ie,{ref:"uploadRef",class:"custom-upload",limit:1,accept:".zip,.rar",data:i(c).data,headers:i(c).headers,action:i(c).url,disabled:i(c).isUploading,"on-progress":X,"on-success":Y,"auto-upload":!1,drag:""},{tip:l(()=>[He]),default:l(()=>[t(se,{class:"el-icon--upload",style:{color:"#409EFF"}},{default:l(()=>[t(ae)]),_:1}),Ae]),_:1},8,["data","headers","action","disabled"])])]),_:1},8,["title","modelValue"]),t(x,{modelValue:i(w),"onUpdate:modelValue":e[11]||(e[11]=a=>E(w)?w.value=a:null),title:"编辑",width:"30%"},{footer:l(()=>[s("span",qe,[t(n,{onClick:e[10]||(e[10]=a=>w.value=!1)},{default:l(()=>[p("取消")]),_:1}),t(n,{type:"primary",onClick:te},{default:l(()=>[p("确定")]),_:1})])]),default:l(()=>[t(g,{model:i(I),rules:q,ref_key:"editDescriptionFormRef",ref:z,"label-position":"top","label-width":"120px"},{default:l(()=>[t(v,{label:"版本说明",prop:"UploadDescription"},{default:l(()=>[t(u,{modelValue:i(I).UploadDescription,"onUpdate:modelValue":e[9]||(e[9]=a=>i(I).UploadDescription=a),type:"textarea",rows:4,placeholder:"请输入文件描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Je=re(Ge,[["__scopeId","data-v-c097760a"]]);export{Je as default};
